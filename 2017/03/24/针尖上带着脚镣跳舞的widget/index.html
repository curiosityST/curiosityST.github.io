<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>针尖上带着脚镣跳舞的widget | Me</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">针尖上带着脚镣跳舞的widget</h1><a id="logo" href="/.">Me</a><p class="description">人生何所求 致富和自由</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">针尖上带着脚镣跳舞的widget</h1><div class="post-meta">Mar 24, 2017<span> | </span><span class="category"><a href="/categories/Widget/">Widget</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><p>自从iOS 10苹果给widget做了一次大改版后，很多人都开发了自己的widget。网上也有很多教程，来告诉你怎么快速开发一个widget。我的这篇文章也不会重复那些简单的创建extension添加证书之类的东西。我们要深入地看一下widget到底应该做成什么样子。</p>
<a id="more"></a>
<h2 id="你真的了解widget的尺寸吗"><a href="#你真的了解widget的尺寸吗" class="headerlink" title="你真的了解widget的尺寸吗"></a>你真的了解widget的尺寸吗</h2><p>首先widget由两种状态</p>
<figure class="highlight mm"><table><tr><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ENUM</span>(<span class="built_in">NSInteger</span>, NCWidgetDisplayMode) &#123;</div><div class="line">    NCWidgetDisplayModeCompact, <span class="comment">// Fixed height</span></div><div class="line">    NCWidgetDisplayModeExpanded, <span class="comment">// Variable height</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>大部分网上的教程都会告诉你，如果你想改widget的高度，都是在下面这个方法中这么写</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)widgetActiveDisplayModeDidChange:(NCWidgetDisplayMode)activeDisplayMode withMaximumSize:(<span class="built_in">CGSize</span>)maxSize &#123;</div><div class="line">    <span class="keyword">if</span> (activeDisplayMode == NCWidgetDisplayModeCompact) &#123;</div><div class="line">        <span class="keyword">self</span>.preferredContentSize = <span class="built_in">CGSizeMake</span>(maxSize.width, <span class="number">110</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">self</span>.preferredContentSize = <span class="built_in">CGSizeMake</span>(maxSize.width, <span class="number">300</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个意思就算折叠状态110，展开状态300。</p>
<p>因为如果你折叠状态就算写120，也一样是110的高度，这个高度不会变化。展开状态下，当然要取比maxSize.height小的一个值。那么maxSize这个值是多少？</p>
<p>然而我要告诉你，<strong>高度根本就不是一个固定值</strong>！并且可以认为是无规律的！！！</p>
<p>因为，整个widget的maxSize限制的<strong>第一规则是根据系统字体大小变化</strong>。</p>
<p>无论是折叠状态还是展开状态。也就是说，直接写死110是错误的。因为默认系统字体下，的确折叠高度是110。但是一旦系统字体改为最小，<strong>widget折叠状态的高度仅为95</strong>，而在系统字体最大的情况下，widget折叠状态的高度是140。而系统字体大小一共有7档。也就是说，<strong>折叠高度和字体大小相关，但不是线性相关</strong>。</p>
<p>可以验证，<strong>折叠的高度是95-100-105-110-120-135-140这七档</strong>。且不可修改。</p>
<p>光折叠高度也就算了。<strong>展开最大高度也是一个非线性相关的高度（并且是在折叠高度统一的情况下）</strong>。</p>
<p>以下对于展开高度的讨论，都固定系统字体大小为默认大小，控制变量（<strong>最终得出的尺寸结果，理论上乘以7就是所有可能的高度</strong>）。</p>
<p>首先就是机型的差异，当然手机屏幕越小，展开最大高度也就越小，这个其实尚可以接受。大不了我们按照最小屏幕的情况开发呗。然而，我要告诉你，widget最大高度还是会变！</p>
<p>这个是我们最常见的widget入口，就是屏幕左滑的Today页</p>
<p><img src="http://oo6vl10at.bkt.clouddn.com/2017-03-24-1.png" alt=""></p>
<p>然而其实还有另外一个入口，就是下拉通知页的左滑，也会有入口</p>
<p><img src="http://oo6vl10at.bkt.clouddn.com/2017-03-24-2.png" alt=""></p>
<p>这两个入口进来，<strong>widget展开状态的最大高度，后者会比前者小很多</strong>！</p>
<p>打断点看maxSize很容易就可以验证，iPhone7默认字体大小，展开状态下。<strong>第一个入口的maxSize.height是616，而另外一个情况下，这个数值变成了528</strong>。</p>
<p><strong>此时真想问一声苹果爸爸，这到底是想搞啥？</strong></p>
<p><em>其实还有第三个入口，就是3D touch app图标，也会出现widget，但是那个只有折叠状态</em></p>
<p><img src="http://oo6vl10at.bkt.clouddn.com/2017-03-24-3.png" alt=""></p>
<p>也就是说，目前来看，<strong>折叠状态是7种尺寸，而每种屏幕大小的展开状态下就是7*2种，也就是说，4吋，4.7吋，5.5吋这三种主流屏幕尺寸都要适配的话，展开状态是7*2*3=42种尺寸</strong>。</p>
<p>看到这你可以说，没关系，我就取4吋设备最小的高度。这个就要看你的设计师能不能同意了。</p>
<p>你以为完了吗？别说iPad呢，那个咱们就不考虑了，iPhone能放下，iPad当然也放得下。</p>
<p>但是你真的想不到，5.5吋也就是<strong>Plus机型的横屏状态</strong>，也是不同尺寸的。<strong>Plus横屏下的展开模式，第一个入口最大高度仅有352，第二入口的最大高度仅264</strong>……</p>
<p>意味着什么，最大字体情况下的折叠状态都有140高度，展开还不到折叠高度的两倍。</p>
<p><strong>如果你对widget的尺寸适配感兴趣，并且有解决方案，请联系我，必有重谢。</strong></p>
<h2 id="有没有感觉被闪瞎了"><a href="#有没有感觉被闪瞎了" class="headerlink" title="有没有感觉被闪瞎了"></a>有没有感觉被闪瞎了</h2><p>你如果添加了很多个widget就会发现，就单单在列表里上下滑动都能把眼睛闪瞎。</p>
<p><img src="http://oo6vl10at.bkt.clouddn.com/2017-03-24-4.gif?imageView2/0/w/400/ignore-error/1" alt=""></p>
<p>Widget 自身的更新机制，是进入到 Widget 后，先执行 viewDidLoad 方法，然后是 viewWillAppear 方法。</p>
<p>但是经测验，每当某一个Widget在上下滑动，滑出屏幕后，再把这个widget划回来，就走上面那一套刷新机制。</p>
<p>由于以上特性，更新代码最好写在 viewWillAppear 方法里面，对于更新时效性特别强的，比如天气类 app，这种最好就是在该方法里面添加一个 NSTimer 定时进行刷新，在 viewWillDisAppear 方法中 进行 取消NSTimer invalidate定时更新即可。</p>
<p>或者，你自己实现缓存，一样可以优化。判断如果请求来的数据和当前数据内容一致，那么就不进行刷新列表操作。</p>
<p>知乎、得到 等等好多app的 Widget，只要走 viewDidLoad 方法就会闪一下，因为每次Widget加载请求的数据后会进行替换造成的。</p>
<p>至于为什么只要不再视线范围再回来就刷新，我猜测，是因为内存问题。</p>
<p>widget对内存的要求之高令人发指，你的widget中一旦有gif，基本上就完全没有办法显示，过一会就会显示无法载入。不仅如此，反复来回滚动widget页面，以不断刷新也会导致占用内存升高，不太清楚这个是不是苹果的BUG，但是我自己的测试中，<strong>尽量都让单个的widget内存占用小于15M，这样被杀掉内存的机会很小</strong>。</p>
<p>所以，我在开发的时候，gif图都只取第一帧。并且尽可能不主动刷新UI，保持widget内存处于一个较低的水平。</p>
<p>而且由于extension实际上不能直接使用主target中的那些框架，所以，我也写了一些最基本的功能组件。</p>
<p>首先当然是缓存系统，图片缓存尤其关键，因为widget这种特性，会反复刷新，如果没有缓存系统，是非常大的浪费。首先就是图片缓存：</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">"QDTEImageCache.h"</span></span></div><div class="line"><span class="meta">#import <span class="meta-string">&lt;CommonCrypto/CommonDigest.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">QDTEImageCache</span></span></div><div class="line"></div><div class="line">+ (<span class="keyword">instancetype</span>)shareImageCache &#123;</div><div class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> once;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">id</span> instance;</div><div class="line">    <span class="built_in">dispatch_once</span>(&amp;once, ^&#123;</div><div class="line">        instance = [<span class="keyword">self</span> new];</div><div class="line">    &#125;);</div><div class="line">    <span class="keyword">return</span> instance;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">BOOL</span>)isExistCacheForKey:(<span class="built_in">NSString</span> *)key &#123;</div><div class="line">    key = [<span class="keyword">self</span> cachedFileNameForKey:key];</div><div class="line">    <span class="built_in">NSString</span> *filePath = [[<span class="keyword">self</span> getCachePath] stringByAppendingPathComponent:key];</div><div class="line">    <span class="keyword">return</span> [[<span class="built_in">NSFileManager</span> defaultManager] fileExistsAtPath:filePath];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">NSData</span> *)getImageDataForKey:(<span class="built_in">NSString</span> *)key &#123;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span> isExistCacheForKey:key]) &#123;</div><div class="line">        <span class="keyword">return</span> [<span class="built_in">NSData</span> dataWithContentsOfFile:[[<span class="keyword">self</span> getCachePath] stringByAppendingPathComponent:[<span class="keyword">self</span> cachedFileNameForKey:key]]];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)saveToCacheWithData:(<span class="built_in">NSData</span> *)data forKey:(<span class="built_in">NSString</span> *)key &#123;</div><div class="line">    key = [<span class="keyword">self</span> cachedFileNameForKey:key];</div><div class="line">    <span class="built_in">NSString</span> *filePath = [[<span class="keyword">self</span> getCachePath] stringByAppendingPathComponent:key];</div><div class="line">    </div><div class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</div><div class="line">        [data writeToFile:filePath atomically:<span class="literal">YES</span>];</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">NSString</span> *)getCachePath &#123;</div><div class="line">    <span class="built_in">NSFileManager</span> *fileMgr = [<span class="built_in">NSFileManager</span> defaultManager];</div><div class="line">    <span class="built_in">NSString</span> *containerPath = [[fileMgr containerURLForSecurityApplicationGroupIdentifier:<span class="string">@"group.com.XXXXXXX"</span>] path];</div><div class="line">    </div><div class="line">    <span class="built_in">NSString</span> *path = [containerPath stringByAppendingString:<span class="string">@"/Caches/"</span>];</div><div class="line">    <span class="keyword">if</span> (![fileMgr fileExistsAtPath:path]) &#123;</div><div class="line">        <span class="built_in">BOOL</span> res = [fileMgr createDirectoryAtPath:path</div><div class="line">                      withIntermediateDirectories:<span class="literal">YES</span></div><div class="line">                                       attributes:<span class="literal">nil</span></div><div class="line">                                            error:<span class="literal">nil</span>];</div><div class="line">        <span class="keyword">if</span> (!res) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> path;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">NSString</span> *)cachedFileNameForKey:(<span class="built_in">NSString</span> *)key &#123;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *str = [key UTF8String];</div><div class="line">    <span class="keyword">if</span> (str == <span class="literal">NULL</span>) &#123;</div><div class="line">        str = <span class="string">""</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> r[CC_MD5_DIGEST_LENGTH];</div><div class="line">    CC_MD5(str, (CC_LONG)strlen(str), r);</div><div class="line">    <span class="built_in">NSString</span> *filename = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%@"</span>,</div><div class="line">                          r[<span class="number">0</span>], r[<span class="number">1</span>], r[<span class="number">2</span>], r[<span class="number">3</span>], r[<span class="number">4</span>], r[<span class="number">5</span>], r[<span class="number">6</span>], r[<span class="number">7</span>], r[<span class="number">8</span>], r[<span class="number">9</span>], r[<span class="number">10</span>],</div><div class="line">                          r[<span class="number">11</span>], r[<span class="number">12</span>], r[<span class="number">13</span>], r[<span class="number">14</span>], r[<span class="number">15</span>], [[key pathExtension] isEqualToString:<span class="string">@""</span>] ? <span class="string">@""</span> : [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@".%@"</span>, [key pathExtension]]];</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> filename;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>一个非常基础的图片缓存，同时配合文件管理类, 来管理接口返回的response：</p>
<p>控制器发出的请求，收到response的data时做一次缓存并比对</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session dataTask:(<span class="built_in">NSURLSessionDataTask</span> *)dataTask didReceiveData:(<span class="built_in">NSData</span> *)data &#123;</div><div class="line">    [<span class="keyword">self</span>.jsonData appendData:data];</div><div class="line">    <span class="built_in">NSDictionary</span> *dic = [[<span class="built_in">NSJSONSerialization</span> JSONObjectWithData:<span class="keyword">self</span>.jsonData options:<span class="built_in">NSJSONReadingMutableContainers</span> error:<span class="literal">nil</span>] <span class="keyword">copy</span>];</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (dic == <span class="literal">nil</span>) <span class="keyword">return</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">self</span>.jsonData = <span class="literal">nil</span>;</div><div class="line">    </div><div class="line">    <span class="built_in">NSDictionary</span> *metaDic = [dic valueForKey:<span class="string">@"meta"</span>];</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> ([[metaDic valueForKey:<span class="string">@"status"</span>] integerValue] == <span class="number">200</span>) &#123;</div><div class="line">        </div><div class="line">        <span class="built_in">NSArray</span> *papers = [[dic valueForKey:<span class="string">@"response"</span>] valueForKey:<span class="string">@"papers"</span>];</div><div class="line">        <span class="built_in">NSDictionary</span> *paperDic = [papers firstObject];</div><div class="line">        </div><div class="line">        [_fileMgr saveToCacheWithRawDic:paperDic];</div><div class="line">        </div><div class="line">        QDTELabModel *labModle = [<span class="keyword">self</span> modelFromRawDic:paperDic];</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (labModle.article_id.longValue == <span class="keyword">self</span>.labModel.article_id.longValue) <span class="keyword">return</span>;</div><div class="line">        </div><div class="line">        <span class="keyword">self</span>.labModel = labModle;</div><div class="line">        <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</div><div class="line">            <span class="keyword">for</span> (<span class="built_in">UIView</span> *subView <span class="keyword">in</span> <span class="keyword">self</span>.view.subviews) &#123;</div><div class="line">                [subView removeFromSuperview];</div><div class="line">            &#125;</div><div class="line">            [<span class="keyword">self</span> refreshContentView];</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>文件管理类用来储存</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">"QDTEFileManager.h"</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">QDTEFileManager</span></span></div><div class="line">+ (<span class="keyword">instancetype</span>)shareManager &#123;</div><div class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> once;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">id</span> instance;</div><div class="line">    <span class="built_in">dispatch_once</span>(&amp;once, ^&#123;</div><div class="line">        instance = [<span class="keyword">self</span> new];</div><div class="line">    &#125;);</div><div class="line">    <span class="keyword">return</span> instance;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">NSDictionary</span> *)getUserinfo &#123;</div><div class="line">    <span class="built_in">NSFileManager</span> *fileMgr = [<span class="built_in">NSFileManager</span> defaultManager];</div><div class="line">    <span class="built_in">NSString</span> *containerPath = [[fileMgr containerURLForSecurityApplicationGroupIdentifier:<span class="string">@"group.com.XXXXXX"</span>] path];</div><div class="line">    </div><div class="line">    <span class="built_in">NSString</span> *filePath = [containerPath stringByAppendingPathComponent:<span class="string">@"QDUserinfo.json"</span>];</div><div class="line">    <span class="keyword">if</span> ([fileMgr fileExistsAtPath:filePath]) &#123;</div><div class="line">        <span class="built_in">NSError</span> *error;</div><div class="line">        <span class="keyword">return</span> [[<span class="built_in">NSJSONSerialization</span> JSONObjectWithData:[<span class="built_in">NSData</span> dataWithContentsOfFile:filePath] options:<span class="built_in">NSJSONReadingMutableContainers</span> error:&amp;error] <span class="keyword">copy</span>];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">NSDictionary</span> *)getRawDicFromCache &#123;</div><div class="line">    <span class="built_in">NSFileManager</span> *fileMgr = [<span class="built_in">NSFileManager</span> defaultManager];</div><div class="line">    <span class="built_in">NSString</span> *containerPath = [[fileMgr containerURLForSecurityApplicationGroupIdentifier:<span class="string">@"group.com.XXXXXX"</span>] path];</div><div class="line">    <span class="built_in">NSString</span> *path = [containerPath stringByAppendingString:<span class="string">@"/Caches/"</span>];</div><div class="line">    <span class="built_in">NSString</span> *filePath = [path stringByAppendingPathComponent:<span class="string">@"QDLabCache.json"</span>];</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> ([fileMgr fileExistsAtPath:filePath]) &#123;</div><div class="line">        <span class="built_in">NSError</span> *error;</div><div class="line">        <span class="built_in">NSDictionary</span> *rawDic = [[<span class="built_in">NSJSONSerialization</span> JSONObjectWithData:[<span class="built_in">NSData</span> dataWithContentsOfFile:filePath] options:<span class="built_in">NSJSONReadingMutableContainers</span> error:&amp;error] <span class="keyword">copy</span>];</div><div class="line">        <span class="keyword">return</span> rawDic;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)saveToCacheWithRawDic:(<span class="built_in">NSDictionary</span> *)rawDic &#123;</div><div class="line">    <span class="built_in">NSFileManager</span> *fileMgr = [<span class="built_in">NSFileManager</span> defaultManager];</div><div class="line">    <span class="built_in">NSString</span> *containerPath = [[fileMgr containerURLForSecurityApplicationGroupIdentifier:<span class="string">@"group.com.XXXXXX"</span>] path];</div><div class="line">    </div><div class="line">    <span class="built_in">NSString</span> *path = [containerPath stringByAppendingString:<span class="string">@"/Caches/"</span>];</div><div class="line">    <span class="built_in">BOOL</span> res = [fileMgr createDirectoryAtPath:path</div><div class="line">                  withIntermediateDirectories:<span class="literal">YES</span></div><div class="line">                                   attributes:<span class="literal">nil</span></div><div class="line">                                        error:<span class="literal">nil</span>];</div><div class="line">    <span class="keyword">if</span> (!res) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">NSString</span> *filePath = [path stringByAppendingPathComponent:<span class="string">@"QDLabCache.json"</span>];</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> ([<span class="built_in">NSJSONSerialization</span> isValidJSONObject:rawDic])</div><div class="line">    &#123;</div><div class="line">        <span class="built_in">NSError</span> *error;</div><div class="line">        <span class="built_in">NSData</span> *jsonData = [<span class="built_in">NSJSONSerialization</span> dataWithJSONObject:rawDic</div><div class="line">                                                           options:<span class="built_in">NSJSONWritingPrettyPrinted</span></div><div class="line">                                                             error:&amp;error];</div><div class="line">        </div><div class="line">        <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</div><div class="line">            [jsonData writeToFile:filePath atomically:<span class="literal">YES</span>];</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">NSString</span> *)getServerIP</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span> getDEBUG]) &#123;</div><div class="line">        <span class="built_in">NSFileManager</span> *fileMgr = [<span class="built_in">NSFileManager</span> defaultManager];</div><div class="line">        <span class="built_in">NSString</span> *containerPath = [[fileMgr containerURLForSecurityApplicationGroupIdentifier:<span class="string">@"group.com.XXXXXX"</span>] path];</div><div class="line">        </div><div class="line">        <span class="built_in">NSString</span> *filePath = [containerPath stringByAppendingPathComponent:<span class="string">@"QDServerIP.json"</span>];</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> ([fileMgr fileExistsAtPath:filePath]) &#123;</div><div class="line">            <span class="built_in">NSError</span> *error;</div><div class="line">            <span class="built_in">NSArray</span> *serverIPArr = [[<span class="built_in">NSJSONSerialization</span> JSONObjectWithData:[<span class="built_in">NSData</span> dataWithContentsOfFile:filePath] options:<span class="built_in">NSJSONReadingMutableContainers</span> error:&amp;error] <span class="keyword">copy</span>];</div><div class="line">            <span class="keyword">return</span> serverIPArr.firstObject;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="string">@"http://app3.qdaily.com"</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">BOOL</span>)getDEBUG &#123;</div><div class="line"><span class="meta">#ifdef DEBUG</span></div><div class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</div><div class="line"><span class="meta">#elif BETA</span></div><div class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</div><div class="line"><span class="meta">#else</span></div><div class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</div><div class="line"><span class="meta">#endif</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<hr>
<p>最后呢，这个是我其中一个widget的文件结构。</p>
<p><img src="http://oo6vl10at.bkt.clouddn.com/2017-03-24-5.png" alt=""></p>
<p>widget虽小，但是我当时在开发的时候还是尽量想怎么复杂怎么做，毕竟这种东西，开发一次，几乎以后再也不会去动了。毕竟……<strong>针尖上还要带着脚镣跳舞实在太累了</strong>😂。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://suntao.me/2017/03/24/针尖上带着脚镣跳舞的widget/" data-id="cj1dhj6sd0006arfyr2bedrow" class="article-share-link">分享到</a><div class="tags"><a href="/tags/iOS10-Widget/">iOS10 Widget</a></div><div class="post-nav"><a href="/2017/03/14/从-property说起（四）深入成员变量/" class="pre">从@property说起（四）深入成员变量</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://suntao.me"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/03/24/针尖上带着脚镣跳舞的widget/">针尖上带着脚镣跳舞的widget</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/14/从-property说起（四）深入成员变量/">从@property说起（四）深入成员变量</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/09/从-property说起（三）atomic与多线程锁/">从@property说起（三）atomic与多线程锁</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/21/从-property说起（二）当我们写下-property-nonatomic-weak-id-obj时，我们究竟写了什么/">从@property说起（二）weak关键字</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/20/从@property说起（一）开题篇/">从@property说起（一）开题篇</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/13/iOS 客户端基于 WebP 图片格式的流量优化（下）/">iOS 客户端基于 WebP 图片格式的流量优化（下）</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/11/iOS 客户端基于 WebP 图片格式的流量优化（上）/">iOS 客户端基于 WebP 图片格式的流量优化（上）</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/WebP/">WebP</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Widget/">Widget</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/从-property说起/">从@property说起</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/iOS实际应用/" style="font-size: 15px;">iOS实际应用</a> <a href="/tags/OC基础/" style="font-size: 15px;">OC基础</a> <a href="/tags/iOS10-Widget/" style="font-size: 15px;">iOS10 Widget</a></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Me.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>