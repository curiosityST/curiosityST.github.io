<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>针尖上带着脚镣跳舞的widget | Curiosity小鶸</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">针尖上带着脚镣跳舞的widget</h1><a id="logo" href="/.">Curiosity小鶸</a><p class="description">人生何所求 致富和自由</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">针尖上带着脚镣跳舞的widget</h1><div class="post-meta">Mar 24, 2017<span> | </span><span class="category"><a href="/categories/Widget/">Widget</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><p>自从iOS 10苹果给widget做了一次大改版后，很多人都开发了自己的widget。网上也有很多教程，来告诉你怎么快速开发一个widget。我的这篇文章也不会重复那些简单的创建extension添加证书之类的东西。我们要深入地看一下widget到底应该做成什么样子。</p>
<a id="more"></a>
<h2 id="你真的了解widget的尺寸吗"><a href="#你真的了解widget的尺寸吗" class="headerlink" title="你真的了解widget的尺寸吗"></a>你真的了解widget的尺寸吗</h2><p>首先widget由两种状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">typedef NS_ENUM(NSInteger, NCWidgetDisplayMode) &#123;</div><div class="line">    NCWidgetDisplayModeCompact, // Fixed height</div><div class="line">    NCWidgetDisplayModeExpanded, // Variable height</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>大部分网上的教程都会告诉你，如果你想改widget的高度，都是在下面这个方法中这么写</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">- (void)widgetActiveDisplayModeDidChange:(NCWidgetDisplayMode)activeDisplayMode withMaximumSize:(CGSize)maxSize &#123;</div><div class="line">    if (activeDisplayMode == NCWidgetDisplayModeCompact) &#123;</div><div class="line">        self.preferredContentSize = CGSizeMake(maxSize.width, 110);</div><div class="line">    &#125; else &#123;</div><div class="line">        self.preferredContentSize = CGSizeMake(maxSize.width, 300);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个意思就算折叠状态110，展开状态300。</p>
<p>因为如果你折叠状态就算写120，也一样是110的高度，这个高度不会变化。展开状态下，当然要取比maxSize.height小的一个值。那么maxSize这个值是多少？</p>
<p>然而我要告诉你，<strong>高度根本就不是一个固定值</strong>！并且可以认为是无规律的！！！</p>
<p>因为，整个widget的maxSize限制的<strong>第一规则是根据系统字体大小变化</strong>。</p>
<p>无论是折叠状态还是展开状态。也就是说，直接写死110是错误的。因为默认系统字体下，的确折叠高度是110。但是一旦系统字体改为最小，<strong>widget折叠状态的高度仅为95</strong>，而在系统字体最大的情况下，widget折叠状态的高度是140。而系统字体大小一共有7档。也就是说，<strong>折叠高度和字体大小相关，但不是线性相关</strong>。</p>
<p>可以验证，<strong>折叠的高度是95-100-105-110-120-135-140这七档</strong>。且不可修改。</p>
<p>光折叠高度也就算了。<strong>展开最大高度也是一个非线性相关的高度（并且是在折叠高度统一的情况下）</strong>。</p>
<p>以下对于展开高度的讨论，都固定系统字体大小为默认大小，控制变量（<strong>最终得出的尺寸结果，理论上乘以7就是所有可能的高度</strong>）。</p>
<p>首先就是机型的差异，当然手机屏幕越小，展开最大高度也就越小，这个其实尚可以接受。大不了我们按照最小屏幕的情况开发呗。然而，我要告诉你，widget最大高度还是会变！</p>
<p>这个是我们最常见的widget入口，就是屏幕左滑的Today页</p>
<p><img src="https://segmentfault.com/img/bVLsrT?w=750&amp;h=1378" alt=""></p>
<p>然而其实还有另外一个入口，就是下拉通知页的左滑，也会有入口</p>
<p><img src="https://segmentfault.com/img/bVLsr1?w=750&amp;h=1378" alt=""></p>
<p>这两个入口进来，<strong>widget展开状态的最大高度，后者会比前者小很多</strong>！</p>
<p>打断点看maxSize很容易就可以验证，iPhone7默认字体大小，展开状态下。<strong>第一个入口的maxSize.height是616，而另外一个情况下，这个数值变成了528</strong>。</p>
<p><strong>此时真想问一声苹果爸爸，这到底是想搞啥？</strong></p>
<p><em>其实还有第三个入口，就是3D touch app图标，也会出现widget，但是那个只有折叠状态</em></p>
<p><img src="https://segmentfault.com/img/bVLss2?w=750&amp;h=1334" alt=""></p>
<p>也就是说，目前来看，<strong>折叠状态是7种尺寸，而每种屏幕大小的展开状态下就是7*2种，也就是说，4吋，4.7吋，5.5吋这三种主流屏幕尺寸都要适配的话，展开状态是7*2*3=42种尺寸</strong>。</p>
<p>看到这你可以说，没关系，我就取4吋设备最小的高度。这个就要看你的设计师能不能同意了。</p>
<p>你以为完了吗？别说iPad呢，那个咱们就不考虑了，iPhone能放下，iPad当然也放得下。</p>
<p>但是你真的想不到，5.5吋也就是<strong>Plus机型的横屏状态</strong>，也是不同尺寸的。<strong>Plus横屏下的展开模式，第一个入口最大高度仅有352，第二入口的最大高度仅264</strong>……</p>
<p>意味着什么，最大字体情况下的折叠状态都有140高度，展开还不到折叠高度的两倍。</p>
<p><strong>如果你对widget的尺寸适配感兴趣，并且有解决方案，请联系我，必有重谢。</strong></p>
<h2 id="有没有感觉被闪瞎了"><a href="#有没有感觉被闪瞎了" class="headerlink" title="有没有感觉被闪瞎了"></a>有没有感觉被闪瞎了</h2><p>你如果添加了很多个widget就会发现，就单单在列表里上下滑动都能把眼睛闪瞎。</p>
<p><img src="https://segmentfault.com/img/bVLswP?w=368&amp;h=659" alt=""></p>
<p>Widget 自身的更新机制，是进入到 Widget 后，先执行 viewDidLoad 方法，然后是 viewWillAppear 方法。</p>
<p>但是经测验，每当某一个Widget在上下滑动，滑出屏幕后，再把这个widget划回来，就走上面那一套刷新机制。</p>
<p>由于以上特性，更新代码最好写在 viewWillAppear 方法里面，对于更新时效性特别强的，比如天气类 app，这种最好就是在该方法里面添加一个 NSTimer 定时进行刷新，在 viewWillDisAppear 方法中 进行 取消NSTimer invalidate定时更新即可。</p>
<p>或者，你自己实现缓存，一样可以优化。判断如果请求来的数据和当前数据内容一致，那么就不进行刷新列表操作。</p>
<p>知乎、得到 等等好多app的 Widget，只要走 viewDidLoad 方法就会闪一下，因为每次Widget加载请求的数据后会进行替换造成的。</p>
<p>至于为什么只要不再视线范围再回来就刷新，我猜测，是因为内存问题。</p>
<p>widget对内存的要求之高令人发指，你的widget中一旦有gif，基本上就完全没有办法显示，过一会就会显示无法载入。不仅如此，反复来回滚动widget页面，以不断刷新也会导致占用内存升高，不太清楚这个是不是苹果的BUG，但是我自己的测试中，<strong>尽量都让单个的widget内存占用小于15M，这样被杀掉内存的机会很小</strong>。</p>
<p>所以，我在开发的时候，gif图都只取第一帧。并且尽可能不主动刷新UI，保持widget内存处于一个较低的水平。</p>
<p>而且由于extension实际上不能直接使用主target中的那些框架，所以，我也写了一些最基本的功能组件。</p>
<p>首先当然是缓存系统，图片缓存尤其关键，因为widget这种特性，会反复刷新，如果没有缓存系统，是非常大的浪费。首先就是图片缓存：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line">#import &quot;QDTEImageCache.h&quot;</div><div class="line">#import &lt;CommonCrypto/CommonDigest.h&gt;</div><div class="line"></div><div class="line">@implementation QDTEImageCache</div><div class="line"></div><div class="line">+ (instancetype)shareImageCache &#123;</div><div class="line">    static dispatch_once_t once;</div><div class="line">    static id instance;</div><div class="line">    dispatch_once(&amp;once, ^&#123;</div><div class="line">        instance = [self new];</div><div class="line">    &#125;);</div><div class="line">    return instance;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (BOOL)isExistCacheForKey:(NSString *)key &#123;</div><div class="line">    key = [self cachedFileNameForKey:key];</div><div class="line">    NSString *filePath = [[self getCachePath] stringByAppendingPathComponent:key];</div><div class="line">    return [[NSFileManager defaultManager] fileExistsAtPath:filePath];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (NSData *)getImageDataForKey:(NSString *)key &#123;</div><div class="line">    </div><div class="line">    if ([self isExistCacheForKey:key]) &#123;</div><div class="line">        return [NSData dataWithContentsOfFile:[[self getCachePath] stringByAppendingPathComponent:[self cachedFileNameForKey:key]]];</div><div class="line">    &#125;</div><div class="line">    return nil;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)saveToCacheWithData:(NSData *)data forKey:(NSString *)key &#123;</div><div class="line">    key = [self cachedFileNameForKey:key];</div><div class="line">    NSString *filePath = [[self getCachePath] stringByAppendingPathComponent:key];</div><div class="line">    </div><div class="line">    dispatch_async(dispatch_get_global_queue(0, 0), ^&#123;</div><div class="line">        [data writeToFile:filePath atomically:YES];</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">&#125;</div><div class="line"></div><div class="line">- (NSString *)getCachePath &#123;</div><div class="line">    NSFileManager *fileMgr = [NSFileManager defaultManager];</div><div class="line">    NSString *containerPath = [[fileMgr containerURLForSecurityApplicationGroupIdentifier:@&quot;group.com.XXXXXXX&quot;] path];</div><div class="line">    </div><div class="line">    NSString *path = [containerPath stringByAppendingString:@&quot;/Caches/&quot;];</div><div class="line">    if (![fileMgr fileExistsAtPath:path]) &#123;</div><div class="line">        BOOL res = [fileMgr createDirectoryAtPath:path</div><div class="line">                      withIntermediateDirectories:YES</div><div class="line">                                       attributes:nil</div><div class="line">                                            error:nil];</div><div class="line">        if (!res) &#123;</div><div class="line">            return nil;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    return path;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (NSString *)cachedFileNameForKey:(NSString *)key &#123;</div><div class="line">    const char *str = [key UTF8String];</div><div class="line">    if (str == NULL) &#123;</div><div class="line">        str = &quot;&quot;;</div><div class="line">    &#125;</div><div class="line">    unsigned char r[CC_MD5_DIGEST_LENGTH];</div><div class="line">    CC_MD5(str, (CC_LONG)strlen(str), r);</div><div class="line">    NSString *filename = [NSString stringWithFormat:@&quot;%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%@&quot;,</div><div class="line">                          r[0], r[1], r[2], r[3], r[4], r[5], r[6], r[7], r[8], r[9], r[10],</div><div class="line">                          r[11], r[12], r[13], r[14], r[15], [[key pathExtension] isEqualToString:@&quot;&quot;] ? @&quot;&quot; : [NSString stringWithFormat:@&quot;.%@&quot;, [key pathExtension]]];</div><div class="line">    </div><div class="line">    return filename;</div><div class="line">&#125;</div><div class="line">@end</div></pre></td></tr></table></figure>
<p>一个非常基础的图片缓存，同时配合文件管理类, 来管理接口返回的response：</p>
<p>控制器发出的请求，收到response的data时做一次缓存并比对</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">- (void)URLSession:(NSURLSession *)session dataTask:(NSURLSessionDataTask *)dataTask didReceiveData:(NSData *)data &#123;</div><div class="line">    [self.jsonData appendData:data];</div><div class="line">    NSDictionary *dic = [[NSJSONSerialization JSONObjectWithData:self.jsonData options:NSJSONReadingMutableContainers error:nil] copy];</div><div class="line">    </div><div class="line">    if (dic == nil) return;</div><div class="line">    </div><div class="line">    self.jsonData = nil;</div><div class="line">    </div><div class="line">    NSDictionary *metaDic = [dic valueForKey:@&quot;meta&quot;];</div><div class="line">    </div><div class="line">    if ([[metaDic valueForKey:@&quot;status&quot;] integerValue] == 200) &#123;</div><div class="line">        </div><div class="line">        NSArray *papers = [[dic valueForKey:@&quot;response&quot;] valueForKey:@&quot;papers&quot;];</div><div class="line">        NSDictionary *paperDic = [papers firstObject];</div><div class="line">        </div><div class="line">        [_fileMgr saveToCacheWithRawDic:paperDic];</div><div class="line">        </div><div class="line">        QDTELabModel *labModle = [self modelFromRawDic:paperDic];</div><div class="line">        </div><div class="line">        if (labModle.article_id.longValue == self.labModel.article_id.longValue) return;</div><div class="line">        </div><div class="line">        self.labModel = labModle;</div><div class="line">        dispatch_async(dispatch_get_main_queue(), ^&#123;</div><div class="line">            for (UIView *subView in self.view.subviews) &#123;</div><div class="line">                [subView removeFromSuperview];</div><div class="line">            &#125;</div><div class="line">            [self refreshContentView];</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>文件管理类用来储存</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div></pre></td><td class="code"><pre><div class="line">#import &quot;QDTEFileManager.h&quot;</div><div class="line"></div><div class="line">@implementation QDTEFileManager</div><div class="line">+ (instancetype)shareManager &#123;</div><div class="line">    static dispatch_once_t once;</div><div class="line">    static id instance;</div><div class="line">    dispatch_once(&amp;once, ^&#123;</div><div class="line">        instance = [self new];</div><div class="line">    &#125;);</div><div class="line">    return instance;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (NSDictionary *)getUserinfo &#123;</div><div class="line">    NSFileManager *fileMgr = [NSFileManager defaultManager];</div><div class="line">    NSString *containerPath = [[fileMgr containerURLForSecurityApplicationGroupIdentifier:@&quot;group.com.XXXXXX&quot;] path];</div><div class="line">    </div><div class="line">    NSString *filePath = [containerPath stringByAppendingPathComponent:@&quot;QDUserinfo.json&quot;];</div><div class="line">    if ([fileMgr fileExistsAtPath:filePath]) &#123;</div><div class="line">        NSError *error;</div><div class="line">        return [[NSJSONSerialization JSONObjectWithData:[NSData dataWithContentsOfFile:filePath] options:NSJSONReadingMutableContainers error:&amp;error] copy];</div><div class="line">    &#125;</div><div class="line">    return nil;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (NSDictionary *)getRawDicFromCache &#123;</div><div class="line">    NSFileManager *fileMgr = [NSFileManager defaultManager];</div><div class="line">    NSString *containerPath = [[fileMgr containerURLForSecurityApplicationGroupIdentifier:@&quot;group.com.XXXXXX&quot;] path];</div><div class="line">    NSString *path = [containerPath stringByAppendingString:@&quot;/Caches/&quot;];</div><div class="line">    NSString *filePath = [path stringByAppendingPathComponent:@&quot;QDLabCache.json&quot;];</div><div class="line">    </div><div class="line">    if ([fileMgr fileExistsAtPath:filePath]) &#123;</div><div class="line">        NSError *error;</div><div class="line">        NSDictionary *rawDic = [[NSJSONSerialization JSONObjectWithData:[NSData dataWithContentsOfFile:filePath] options:NSJSONReadingMutableContainers error:&amp;error] copy];</div><div class="line">        return rawDic;</div><div class="line">    &#125;</div><div class="line">    return nil;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)saveToCacheWithRawDic:(NSDictionary *)rawDic &#123;</div><div class="line">    NSFileManager *fileMgr = [NSFileManager defaultManager];</div><div class="line">    NSString *containerPath = [[fileMgr containerURLForSecurityApplicationGroupIdentifier:@&quot;group.com.XXXXXX&quot;] path];</div><div class="line">    </div><div class="line">    NSString *path = [containerPath stringByAppendingString:@&quot;/Caches/&quot;];</div><div class="line">    BOOL res = [fileMgr createDirectoryAtPath:path</div><div class="line">                  withIntermediateDirectories:YES</div><div class="line">                                   attributes:nil</div><div class="line">                                        error:nil];</div><div class="line">    if (!res) &#123;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    NSString *filePath = [path stringByAppendingPathComponent:@&quot;QDLabCache.json&quot;];</div><div class="line">    </div><div class="line">    if ([NSJSONSerialization isValidJSONObject:rawDic])</div><div class="line">    &#123;</div><div class="line">        NSError *error;</div><div class="line">        NSData *jsonData = [NSJSONSerialization dataWithJSONObject:rawDic</div><div class="line">                                                           options:NSJSONWritingPrettyPrinted</div><div class="line">                                                             error:&amp;error];</div><div class="line">        </div><div class="line">        dispatch_async(dispatch_get_global_queue(0, 0), ^&#123;</div><div class="line">            [jsonData writeToFile:filePath atomically:YES];</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (NSString *)getServerIP</div><div class="line">&#123;</div><div class="line">    if ([self getDEBUG]) &#123;</div><div class="line">        NSFileManager *fileMgr = [NSFileManager defaultManager];</div><div class="line">        NSString *containerPath = [[fileMgr containerURLForSecurityApplicationGroupIdentifier:@&quot;group.com.XXXXXX&quot;] path];</div><div class="line">        </div><div class="line">        NSString *filePath = [containerPath stringByAppendingPathComponent:@&quot;QDServerIP.json&quot;];</div><div class="line">        </div><div class="line">        if ([fileMgr fileExistsAtPath:filePath]) &#123;</div><div class="line">            NSError *error;</div><div class="line">            NSArray *serverIPArr = [[NSJSONSerialization JSONObjectWithData:[NSData dataWithContentsOfFile:filePath] options:NSJSONReadingMutableContainers error:&amp;error] copy];</div><div class="line">            return serverIPArr.firstObject;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return @&quot;http://app3.qdaily.com&quot;;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (BOOL)getDEBUG &#123;</div><div class="line">#ifdef DEBUG</div><div class="line">    return YES;</div><div class="line">#elif BETA</div><div class="line">    return YES;</div><div class="line">#else</div><div class="line">    return NO;</div><div class="line">#endif</div><div class="line">&#125;</div><div class="line">@end</div></pre></td></tr></table></figure>
<hr>
<p>最后呢，这个是我其中一个widget的文件结构。</p>
<p><img src="https://segmentfault.com/img/bVLsDp?w=570&amp;h=1278" alt=""></p>
<p>widget虽小，但是我当时在开发的时候还是尽量想怎么复杂怎么做，毕竟这种东西，开发一次，几乎以后再也不会去动了。毕竟……<strong>针尖上还要带着脚镣跳舞实在太累了</strong>😂。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://curiosityst.github.io/2017/03/24/针尖上带着脚镣跳舞的widget/" data-id="cj1atpk7o000fvfs60gs7t61d" class="article-share-link">分享到</a><div class="tags"><a href="/tags/iOS10-Widget/">iOS10 Widget</a></div><div class="post-nav"><a href="/2017/03/14/从-property说起（四）深入成员变量/" class="pre">从@property说起（四）深入成员变量</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://curiosityst.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/03/24/针尖上带着脚镣跳舞的widget/">针尖上带着脚镣跳舞的widget</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/14/从-property说起（四）深入成员变量/">从@property说起（四）深入成员变量</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/09/从-property说起（三）atomic与多线程锁/">从@property说起（三）atomic与多线程锁</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/21/从-property说起（二）当我们写下-property-nonatomic-weak-id-obj时，我们究竟写了什么/">从@property说起（二）weak关键字</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/20/从@property说起（一）开题篇/">从@property说起（一）开题篇</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/13/iOS 客户端基于 WebP 图片格式的流量优化（下）/">iOS 客户端基于 WebP 图片格式的流量优化（下）</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/11/iOS 客户端基于 WebP 图片格式的流量优化（上）/">iOS 客户端基于 WebP 图片格式的流量优化（上）</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/WebP/">WebP</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Widget/">Widget</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/从-property说起/">从@property说起</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/iOS实际应用/" style="font-size: 15px;">iOS实际应用</a> <a href="/tags/OC基础/" style="font-size: 15px;">OC基础</a> <a href="/tags/iOS10-Widget/" style="font-size: 15px;">iOS10 Widget</a></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Curiosity小鶸.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>