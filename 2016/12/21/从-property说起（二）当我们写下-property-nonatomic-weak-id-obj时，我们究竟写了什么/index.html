<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>从@property说起（二）weak关键字 | Me</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">从@property说起（二）weak关键字</h1><a id="logo" href="/.">Me</a><p class="description">人生何所求 致富和自由</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">从@property说起（二）weak关键字</h1><div class="post-meta">Dec 21, 2016<span> | </span><span class="category"><a href="/categories/从-property说起/">从@property说起</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><p><strong>当我们写下@property (nonatomic, weak) id obj时，我们究竟写了什么</strong></p>
<p>先看下面一段代码</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">TestClass</span> : <span class="title">NSObject</span></span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="keyword">id</span> foo;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">TestClass</span></span></div><div class="line"><span class="keyword">@synthesize</span> foo = _foo;</div><div class="line"></div><div class="line">- (<span class="keyword">id</span>)foo &#123;</div><div class="line"><span class="keyword">return</span> _foo;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setFoo:(<span class="keyword">id</span>)foo &#123;</div><div class="line">_foo = foo;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line"></div><div class="line">TestClass *obj = [TestClass new];</div><div class="line">obj.foo = [<span class="built_in">NSObject</span> new];</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, obj.foo);</div><div class="line"></div><div class="line"><span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这段代码应该没有疑问，输出的是null。<br>那么究竟为什么是null？如果你仅仅给出答案说，因为foo这个属性是weak修饰，是不是太过简单了点。<br>所以，问题要一点点分析，首先就是：</p>
<h2 id="weak是如何做到不持有对象，但能得到对象值的"><a href="#weak是如何做到不持有对象，但能得到对象值的" class="headerlink" title="weak是如何做到不持有对象，但能得到对象值的"></a>weak是如何做到不持有对象，但能得到对象值的</h2><p>这个问题，首先就是要先知道，weak真正的作用，实际是<strong>weak修饰符。当我们声明一个weak属性foo时，实际是声明了一个</strong>weak id _foo;</p>
<p>于是我们真正要讨论的，是__weak关键字。</p>
<p>实际上这个问题随便搜一下有很多答案，大部分答案都来自于iOS业界著名的一本书——Kazuki Sakamoto所著《Objective-C高级编程》。这本书的确很好，但是，在有些地方个人认为跳跃太大，导致读者容易出现误解。__weak关键字的实现部分就是如此。</p>
<p>首先我们先看书中的解释：</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><div class="line">&#123;</div><div class="line"><span class="keyword">id</span> __<span class="keyword">weak</span> obj1 = obj;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>假设obj附加__strong修饰符并被赋值。<br>编译器会把这段代码转换成运行时代码</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><div class="line"><span class="keyword">id</span> obj1;  </div><div class="line">objc_initWeak(&amp;obj1, obj);  </div><div class="line">objc_destoryWeak(&amp;obj1);</div></pre></td></tr></table></figure>
<p>即编译器会通过objc_initWeak函数初始化__weak修饰的变量，当变量的作用域结束后会通过objc_destoryWeak函数释放该变量。objc_initWeak函数实际干的活是：</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><div class="line">objc1 = <span class="number">0</span>;  </div><div class="line">objc_storeWeak(&amp;obj1, obj);</div></pre></td></tr></table></figure>
<p>这里是先将指针objc1置成0，再调用objc_storeWeak函数使得obj1指向obj对象。</p>
<p>接下来的objc_destoryWeak函数的实际操作如下：</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><div class="line">objc_storeWeak(&amp;obj1, <span class="number">0</span>);</div></pre></td></tr></table></figure>
<p>总结一下，刚才的整个过程模拟代码如下：</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><div class="line"><span class="keyword">id</span> obj1;  </div><div class="line">obj1 = <span class="number">0</span>;  </div><div class="line">objc_storeWeak(&amp;obj1, obj);  </div><div class="line">objc_storeWeak(&amp;obj1, <span class="number">0</span>);</div></pre></td></tr></table></figure>
<p><strong>实际上，objc_storeWeak函数会把第二个参数的对象的地址作为key，并将第一个参数（__weak关键字修饰的指针的地址）作为值，注册到weak表中。如果第二个参数为0（说明对应的对象被释放了），则将weak表中将整个key-value键值对删除，这就是__weak关键字的核心思想！</strong></p>
<p>在那本书，到这里讲得都非常好，然而可能是因为年代久远，当时runtime也没有开源，所以关于 id __weak obj = [NSObject new]这个问题描述不太清晰。<br>下面是我的例子：</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line"><span class="built_in">NSObject</span> *foo = [<span class="built_in">NSObject</span> new];</div><div class="line">__<span class="keyword">weak</span> <span class="keyword">id</span> obj = foo;</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, obj);</div><div class="line">obj = [<span class="built_in">NSObject</span> new];</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, obj);</div><div class="line"><span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>显然第一个log是有值的，第二个log应该是null。<br>那么问题就是，为什么第二个log没有办法取到值。<br>当然这个结果本身就是__weak的特性，我们要讨论的，就是这个特性是如何实现的。</p>
<blockquote>
<p>首先，再给obj声明并赋初值时，foo这个局部变量默认就是__strong的，所以，obj可以储存foo的值。这个没有什么疑问。那么关键就在于，下面的obj = [NSObject new]是不会调用objc_initWeak函数，但是依然成功把obj置空了。</p>
</blockquote>
<p>所以一步步分析：</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><div class="line">obj = [<span class="built_in">NSObject</span> new];</div></pre></td></tr></table></figure>
<p>实际转换为</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><div class="line"><span class="keyword">id</span> objc_storeWeak(&amp;obj, newObj)</div></pre></td></tr></table></figure>
<p>newObj显然不为0，于是storeWeak函数成功返回了id类型的newObj。</p>
<blockquote>
<p>然后关键在于下一步，参数newObj由于没有被任何变量引用，所以newObj的作用域在storeWeak函数返回后，就结束了。</p>
</blockquote>
<p>于是</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><div class="line">newObj调用下面的函数</div><div class="line"><span class="keyword">void</span> objc_release(<span class="keyword">id</span> obj)</div><div class="line">被成功释放</div></pre></td></tr></table></figure>
<p>而在此时，newObj的dealloc是调用了objc_clear_deallocating函数，这个函数实现可以通过runtime源码来查看，其中就包含：</p>
<blockquote>
<p>首找出对象对应的weak_entry_t链表，然后挨个将弱引用置为nil。最后清理对象的记录。</p>
</blockquote>
<p>这样，就会调起obj的objc_destroyWeak(&amp;obj)函数，而这个函数的实现是：</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><div class="line"><span class="keyword">void</span></div><div class="line">objc_destroyWeak(<span class="keyword">id</span> *location)</div><div class="line">&#123;</div><div class="line">(<span class="keyword">void</span>)storeWeak&lt;<span class="literal">true</span><span class="comment">/*old*/</span>, <span class="literal">false</span><span class="comment">/*new*/</span>, <span class="literal">false</span><span class="comment">/*crash*/</span>&gt;</div><div class="line">(location, <span class="literal">nil</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>第二个参数直接传nil，于是清理obj中的值。</p>
<p>所以，我们再回头看一下，@property (nonatomic, weak) id obj的setter方法：</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)setObj:(<span class="keyword">id</span>)obj &#123;</div><div class="line">_obj = obj;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>实际上，setter的实现，在编译完成后，会转换为</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><div class="line">objc_storeWeak(&amp;_obj, obj);</div><div class="line">objc_release(obj);</div></pre></td></tr></table></figure>
<hr>
<p>所以当我们写下</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="keyword">id</span> obj;</div></pre></td></tr></table></figure>
<p>我们到底写下了什么。</p>
<p>在下一篇中，就需要讲一下nonatomic和atomic了</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://suntao.me/2016/12/21/从-property说起（二）当我们写下-property-nonatomic-weak-id-obj时，我们究竟写了什么/" data-id="cj2h51rak000e2afyf3txa02v" class="article-share-link">分享到</a><div class="tags"><a href="/tags/OC基础/">OC基础</a></div><div class="post-nav"><a href="/2016/12/20/从@property说起（一）开题篇/" class="pre">从@property说起（一）开题篇</a><a href="/2017/03/09/从-property说起（三）atomic与多线程锁/" class="next">从@property说起（三）atomic与多线程锁</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://suntao.me"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/04/30/个人对于super的调用过程中，一些不一样的理解/">个人对于super的调用过程中，一些不一样的理解</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/19/闲情——C语言指针/">闲情——C语言指针和数组的探索</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/10/iOS 客户端对于运营商劫持的一点点对抗方式/">iOS 客户端对于运营商劫持的一点点对抗方式</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/24/针尖上带着脚镣跳舞的widget/">针尖上带着脚镣跳舞的widget</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/14/从-property说起（四）深入成员变量/">从@property说起（四）深入成员变量</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/09/从-property说起（三）atomic与多线程锁/">从@property说起（三）atomic与多线程锁</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/21/从-property说起（二）当我们写下-property-nonatomic-weak-id-obj时，我们究竟写了什么/">从@property说起（二）weak关键字</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/20/从@property说起（一）开题篇/">从@property说起（一）开题篇</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/13/iOS 客户端基于 WebP 图片格式的流量优化（下）/">iOS 客户端基于 WebP 图片格式的流量优化（下）</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/11/iOS 客户端基于 WebP 图片格式的流量优化（上）/">iOS 客户端基于 WebP 图片格式的流量优化（上）</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/C语言/">C语言</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/WebP/">WebP</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Widget/">Widget</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/runtime/">runtime</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/从-property说起/">从@property说起</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络/">网络</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/iOS实际应用/" style="font-size: 15px;">iOS实际应用</a> <a href="/tags/防劫持/" style="font-size: 15px;">防劫持</a> <a href="/tags/runtime-OC底层/" style="font-size: 15px;">runtime OC底层</a> <a href="/tags/OC基础/" style="font-size: 15px;">OC基础</a> <a href="/tags/iOS10-Widget/" style="font-size: 15px;">iOS10 Widget</a> <a href="/tags/C指针/" style="font-size: 15px;">C指针</a></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Me.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>